apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Note: Don't blanket set the namespace across all resources as some such as the
# Prometheus exporters rely on being placed in other namespaces such as kube-system.

resources:
- namespace.yaml
- grafana-agent-operator.gen.yaml
- kube-prometheus.gen.yaml
- loki.gen.yaml
- tempo.gen.yaml
- virtual-services.yaml

# Custom resources reconciled by grafana-agent-operator.
- default-grafana-agent.yaml
- default-metrics-instance.yaml
- default-logs-instance.yaml
- default-pod-logs.yaml
- istio-grafana-agent.yaml
- istio-metrics-instance.yaml
- istio-pod-monitor.yaml
- istio-prometheus-rule.yaml
- grafana-agent-monitoring.yaml

patches:
# Inject the grafana-stack namespace into all resources in the grafana-agent-operator
# and loki charts as they don't template the namespace properly. See following issues:
# https://github.com/grafana/loki/issues/8044
# https://github.com/grafana/helm-charts/issues/2098
- path: patches/set-namespace.yaml
  target:
    labelSelector: "app.kubernetes.io/name=grafana-agent-operator"
- path: patches/set-namespace.yaml
  target:
    labelSelector: "app.kubernetes.io/name=loki"

# Add the grafana-agent-metrics-instance=default label to all remaining ServiceMonitors.
# The remaining ServiceMonitors will be associated with workloads that are specifically NOT
# injected with an Istio sidecar. These workloads will be: Prometheus/Grafana agents,
# kube-system workloads, and things like node-exporter which use host networking and so
# are also not injected.
- path: patches/adopt-service-monitor.yaml
  target:
    group: monitoring.coreos.com
    kind: ServiceMonitor
